generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NodeStatus {
  IDLE
  GENERATING
  COMPLETED
  ERROR
  STALE
}

enum ProjectRole {
  OWNER
  ADMIN
  EDITOR
  MEMBER
  VIEWER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String?  @unique
  passwordHash String
  isGuest      Boolean  @default(false)
  firstName    String?
  lastName     String?
  avatar       String?
  preferences  Json?

  refreshToken   RefreshToken?
  ownedProjects  Project[]       @relation("ProjectOwner")
  projectMembers ProjectMember[]
  sessions       UserSession[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("users")
  @@index([email])
  @@index([deletedAt])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
  @@index([expiresAt])
}

model Project {
  id           String  @id @default(cuid())
  name         String
  description  String?
  systemPrompt String  @default("")
  shareToken   String? @unique

  ownerId String
  owner   User @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  members  ProjectMember[]
  nodes    Node[]
  edges    Edge[]
  sessions UserSession[]

  isPublic    Boolean @default(false)
  nodeCount   Int     @default(0)
  memberCount Int     @default(1)
  viewport    Json?
  quickActions Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("projects")
  @@index([ownerId])
  @@index([ownerId, deletedAt])
  @@index([isPublic])
  @@index([deletedAt])
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now())

  @@unique([projectId, userId])
  @@map("project_members")
  @@index([projectId])
  @@index([userId])
}

model Node {
  id        String     @id @default(cuid())
  projectId String
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  prompt   String
  response String?
  summary  String?
  status   NodeStatus @default(IDLE)

  position Json
  metadata Json?
  llmModel  String?
  llmTokens Int?
  llmCost   Float?

  parentEdges Edge[] @relation("NodeSource")
  childEdges  Edge[] @relation("NodeTarget")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("nodes")
  @@index([projectId])
  @@index([projectId, deletedAt])
  @@index([status])
  @@index([projectId, deletedAt, status])
}

model Edge {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  sourceId String
  source   Node @relation("NodeSource", fields: [sourceId], references: [id], onDelete: Cascade)

  targetId String
  target   Node @relation("NodeTarget", fields: [targetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("edges")
  @@index([projectId])
  @@index([sourceId])
  @@index([targetId])
  @@unique([sourceId, targetId])
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cursor    Json?
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  lastSeen  DateTime @default(now())

  @@unique([userId, projectId])
  @@map("user_sessions")
  @@index([projectId])
  @@index([userId])
  @@index([isActive])
}
